
通过对您项目的代码审查，以下是为您整理的**数据存储板块归纳**以及**安全性分级报告**。

您的项目目前是一个典型的混合存储架构：核心高频/高价值数据正在向 **RocksDB (KV数据库)** 迁移，而部分业务逻辑仍依赖 **JSON文件** 和 **内存存储**。

### 1. 核心业务板块与数据存储分布

| 业务板块 | 数据内容 | 当前存储方式 | 关键代码引用 |
| :--- | :--- | :--- | :--- |
| **用户系统** (User System) | 用户资料、钱包地址、角色权限、注册时间 | **RocksDB** (`users` 命名空间) ✅ 已迁移 | [userStorage.js](file:///d:\三大赛\李宽TWS\TaiwanSheng\tws\server\utils\userStorage.js) |
| **投资/众筹** (Investment) | 科技项目信息、用户投资记录、交易签名、分红比例 | **RocksDB** (`investments`, `techProjects`) ✅ 已迁移 | [investmentManager.js](file:///d:\三大赛\李宽TWS\TaiwanSheng\tws\server\utils\investmentManager.js) |
| **资产/军火库** (Assets/Arsenal) | 游戏装备、NFT元数据、地图资产点位 | **RocksDB** (`rawAssets`, `sanitizedAssets`) ✅ 已迁移 | [storage.js](file:///d:\三大赛\李宽TWS\TaiwanSheng\tws\server\utils\storage.js) |
| **预测市场** (Prediction Market) | 赌盘题目、赔率池、开奖时间、**用户下注记录** | **RocksDB** (`predictionMarkets`, `predictionBets`) ✅ 已迁移 | [prediction.js](file:///d:\三大赛\李宽TWS\TaiwanSheng\tws\server\routes\prediction.js) |
| **支付/订单** (Payment) | 充值订单、支付状态、交易哈希 | **RocksDB** (`paymentOrders`) ✅ 已迁移 | [payment.js](file:///d:\三大赛\李宽TWS\TaiwanSheng\tws\server\routes\payment.js) |
| **交易市场** (Marketplace) | 挂单薄 (OrderBook)、历史成交记录 | **RocksDB** (`orderBook`, `trades`) ✅ 已迁移 | [orderMatchingEngine.js](file:///d:\三大赛\李宽TWS\TaiwanSheng\tws\server\utils\orderMatchingEngine.js) |
| **首页数据** (Homepage) | 首页动态内容 | **RocksDB** (`homepage` 命名空间) ✅ 已迁移 | [homepageStorage.js](file:///d:\三大赛\李宽TWS\TaiwanSheng\tws\server\utils\homepageStorage.js) |
| **时间管理** (Time) | 系统时间状态 | **RocksDB** (`time` 命名空间) ✅ 已迁移 | [timeManager.js](file:///d:\三大赛\李宽TWS\TaiwanSheng\tws\server\utils\timeManager.js) |
| **Bot用户** (Bot Users) | 机器人用户数据 | **RocksDB** (`botUsers` 命名空间) ✅ 已迁移 | [botUserManager.js](file:///d:\三大赛\李宽TWS\TaiwanSheng\tws\server\utils\botUserManager.js) |
| **历史记录** (History) | 操作历史 | **RocksDB** (`history` 命名空间) ✅ 已迁移 | [historyManager.js](file:///d:\三大赛\李宽TWS\TaiwanSheng\tws\server\utils\historyManager.js) |

---

### 2. 数据安全性分级 (Security Priority)

根据业务逻辑，我们将数据安全性划分为三个等级，**Level 1 最为重要，必须优先保障**。

#### 🔴 Level 1：最高安全级 (涉及资金与权限)
**这些数据一旦丢失或被篡改，将导致直接的资金损失或系统崩溃。**
1.  **用户私钥与权限配置**
    *   **位置**: `solana_admin_keypair.json` (文件系统), `.env` (环境变量)
    *   **风险**: 管理员权限泄露意味着整个合约资金池可被抽空。
2.  **投资与资产记录 (`investments`, `assets`)**
    *   **存储**: RocksDB
    *   **重要性**: 记录了谁拥有什么（TWS代币、股权、装备）。这是用户资产的链下账本，必须与链上数据严格对应。
3.  **支付订单状态 (`Payment Orders`)**
    *   **存储**: RocksDB ✅
    *   **更新**: 已从内存迁移至 RocksDB，确保持久化存储，防止重启丢失。

#### 🟡 Level 2：高敏感级 (涉及游戏公平性)
1.  **预测市场下注记录 (`predictionBets`)**
    *   **存储**: RocksDB ✅
    *   **重要性**: 决定了开奖时谁能分钱。
2.  **交易撮合挂单 (`orderBook`)**
    *   **存储**: RocksDB ✅
    *   **重要性**: 涉及二级市场的交易公平。

#### 🟢 Level 3：普通级 (公开数据)
1.  **静态内容**: `homepage` 数据。
2.  **历史日志**: `history` 记录。
3.  **Bot用户**: 模拟交易用户。

---

### 3. 已完成的迁移工作

- [x] **支付订单存储**: 已将 `server/routes/payment.js` 中的内存 Map 迁移至 `RocksDB` (`paymentOrders` 命名空间)。
- [x] **投资记录**: 确认已使用 `RocksDB` (`investments` 命名空间)。
- [x] **用户系统**: 确认已使用 `RocksDB` (`users` 命名空间)。
- [x] **预测市场**: 已将 `server/routes/prediction.js` 中的 JSON 读写迁移至 `RocksDB` (`predictionMarkets`, `predictionBets` 命名空间)，并实现了自动迁移备份 (`.json.bak`)。
- [x] **交易市场**: 已将 `server/utils/orderMatchingEngine.js` 中的 JSON 读写迁移至 `RocksDB` (`orderBook`, `trades` 命名空间)，修复了数据读取格式问题，并实现了自动迁移备份。
- [x] **首页数据**: 创建 `homepageStorage.js`，实现 `homepage.json` 到 RocksDB 的迁移与备份。
- [x] **时间管理**: `timeManager.js` 全面重写为异步 RocksDB 存储，保持了 API 兼容性。
- [x] **Bot用户**: `botUserManager.js` 已迁移至 RocksDB。
- [x] **历史记录**: `historyManager.js` 已迁移至 RocksDB，并增加了布隆过滤器缓存优化性能。
- [x] **资产数据**: `storage.js` 中的 `rawAssets` 和 `sanitizedAssets` 已添加迁移逻辑。

### 4. 迁移机制与备份 (Migration & Backup)

系统启动时会自动执行以下数据保护流程：

1.  **自动检测**: 检查 RocksDB 是否为空。
2.  **数据迁移**: 如果 RocksDB 为空但存在旧的 `.json` 文件，系统会自动读取 JSON 数据并写入 RocksDB。
3.  **自动备份**: 迁移成功后，原始 `.json` 文件会被重命名为 `.json.bak`，防止重复迁移并作为冷备份保留。

### 5. Zeabur 部署指南 (RocksDB 专项)

由于本项目使用的是 **RocksDB (嵌入式文件数据库)**，它不是像 MySQL 那样的独立服务，而是直接随代码运行。在 Zeabur 等容器化平台部署时，**必须配置持久化存储**，否则每次重启数据都会丢失。

#### 步骤一：确认项目结构
您的后端代码在 `tws/server` 目录下。在 Zeabur 部署时，请确保服务根目录指向这里。

#### 步骤二：配置持久化卷 (Volume)
这是最关键的一步。

1. 进入 Zeabur 控制台，点击您的后端服务。
2. 切换到 **"Settings" (设置)** -> **"Storage" (存储)** 或 **"Volumes"** 标签页。
3. 点击 **"Add Volume" (添加卷)**。
4. 填写配置：
   *   **Volume Name (卷名)**: 任意起名，例如 `rocksdb-data`。
   *   **Mount Path (挂载路径)**: 填写 `/app/data`。
       *   *解释*: Zeabur 的 Node.js 镜像默认工作目录通常是 `/app`。我们的代码中数据库路径在 `server/data`，因此映射到容器内的 `/app/data` 可以持久化保存所有数据库文件。
       *   *注意*: 如果您的 Dockerfile 自定义了 `WORKDIR`，请相应调整。如果不确定，可以在服务启动后通过 "Terminal" 标签页进入容器执行 `pwd` 查看当前目录。

#### 步骤三：检查构建与运行
RocksDB 是 C++ 编写的原生模块，安装需要编译环境。
*   Zeabur 的默认 Node.js 环境通常已包含必要工具。
*   如果遇到 `Error: /lib/x86_64-linux-gnu/libc.so.6: version 'GLIBC_2.28' not found` 这类错误，说明构建环境与运行环境不一致。建议在 `tws/server` 目录下添加一个 `Dockerfile` 来固定环境。

**推荐 Dockerfile (如果自动部署失败):**
```dockerfile
FROM node:18-slim

# 安装 RocksDB 编译依赖
RUN apt-get update && apt-get install -y python3 make g++

WORKDIR /app

# 复制依赖配置
COPY package*.json ./

# 安装依赖
RUN npm install --production

# 复制源代码
COPY . .

# 暴露端口
EXPOSE 3001

# 启动命令
CMD ["node", "server.js"]
```

#### 步骤四：单实例限制
*   **不要开启水平扩展 (Scale Out)**：RocksDB 只能被一个进程独占锁住。请将服务的 "Replicas" (副本数) 保持为 **1**。
*   如果需要更高性能，请升级单个服务的 CPU/内存配置 (Vertical Scaling)，而不是增加副本数。

#### 步骤五：验证数据持久化
1. 部署成功后，进行一些操作（如修改用户数据、下注等）。
2. 在 Zeabur 控制台重启服务 (Restart)。
3. 服务启动后，检查数据是否依然存在。如果数据丢失，说明 **步骤二** 中的挂载路径配置错误。
