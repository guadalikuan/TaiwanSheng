# 省市分级选择功能说明

## 📋 功能概述

在资产入库界面添加了**省市分级选择**功能，用户需要先选择省份，然后从该省份的城市列表中选择具体城市。

---

## 🎯 功能特性

### 1. **两级选择**
- **第一级**：选择省份
- **第二级**：根据选择的省份动态加载城市列表

### 2. **动态联动**
- 选择省份后，城市下拉框自动更新为该省份的城市列表
- 自动选择第一个城市作为默认值
- 如果省份变更，城市会自动重置

### 3. **数据覆盖**
- 覆盖全国所有省、自治区、直辖市
- 包含所有地级市、区县等

---

## 🔧 技术实现

### 数据文件

**文件**：`src/utils/chinaRegions.js`

**数据结构**：
```javascript
export const PROVINCES_AND_CITIES = {
  '陕西省': {
    cities: ['西安', '咸阳', '宝鸡', ...]
  },
  '北京市': {
    cities: ['东城区', '西城区', ...]
  },
  // ... 所有省份
};
```

**工具函数**：
- `getProvinceList()`：获取所有省份列表
- `getCitiesByProvince(province)`：根据省份获取城市列表
- `getProvinceByCity(cityName)`：根据城市名称查找所属省份

### 前端组件

**文件**：`src/components/ArsenalEntry.jsx`

**状态管理**：
```javascript
const [formData, setFormData] = useState({
  province: '陕西省', // 默认省份
  city: '西安',      // 默认城市
  // ...
});

const [availableCities, setAvailableCities] = useState(
  getCitiesByProvince('陕西省')
);
```

**联动逻辑**：
```javascript
const handleChange = (e) => {
  const { name, value } = e.target;
  
  if (name === 'province') {
    // 省份变更时，更新城市列表并重置城市选择
    const cities = getCitiesByProvince(value);
    setAvailableCities(cities);
    setFormData({ 
      ...formData, 
      province: value,
      city: cities.length > 0 ? cities[0] : ''
    });
  }
};
```

### 后端 API

**文件**：`server/routes/arsenal.js`

**更新**：
- 接受 `province` 参数（可选）
- 将省份信息保存到原始资产数据中
- 在 `locationAddress` 中包含省份信息

---

## 📊 界面布局

### 表单布局

**之前**（2列）：
```
[所在城市选择框]  [建筑面积输入框]
```

**现在**（3列）：
```
[所在省份选择框]  [所在城市选择框]  [建筑面积输入框]
```

### 选择框样式

- **省份选择框**：显示所有省份，按字母顺序排列
- **城市选择框**：
  - 根据选择的省份动态更新
  - 如果未选择省份，显示"请先选择省份"并禁用
  - 选择省份后自动启用并显示城市列表

---

## 🔄 数据流

### 用户操作流程

1. **选择省份**：
   ```
   用户选择"陕西省"
     ↓
   触发 handleChange
     ↓
   调用 getCitiesByProvince('陕西省')
     ↓
   更新 availableCities 状态
     ↓
   自动选择第一个城市"西安"
   ```

2. **选择城市**：
   ```
   用户从城市列表中选择"咸阳"
     ↓
   更新 formData.city
     ↓
   地图组件接收新的城市信息
   ```

3. **提交资产**：
   ```
   表单提交
     ↓
   submitAsset({
     province: '陕西省',
     city: '咸阳',
     // ...
   })
     ↓
   后端保存原始资产数据
     ↓
   rawAsset = {
     province: '陕西省',
     city: '咸阳',
     // ...
   }
   ```

---

## 🎨 UI 改进

### 视觉变化

1. **表单布局**：
   - 从 2 列改为 3 列布局
   - 省份和城市选择框并排显示
   - 保持响应式设计（移动端自动变为单列）

2. **交互反馈**：
   - 省份选择后，城市选择框立即更新
   - 城市列表为空时显示禁用状态
   - 提供清晰的视觉反馈

---

## 📝 数据存储

### 原始资产数据（rawAssets.json）

新增字段：
```json
{
  "province": "陕西省",
  "city": "西安",
  // ... 其他字段
}
```

### 数据使用

- **地理位置标识**：省份 + 城市组合，更精确地标识资产位置
- **地图定位**：结合省份信息，提高地理编码准确性
- **资产分类**：可按省份和城市进行资产分组和统计

---

## ✅ 功能清单

- [x] 创建省市数据文件
- [x] 添加省份选择下拉框
- [x] 添加城市选择下拉框（动态联动）
- [x] 实现省份变更时城市列表更新
- [x] 实现自动选择第一个城市
- [x] 更新表单布局（3列）
- [x] 更新后端 API 接受省份参数
- [x] 更新数据存储包含省份信息
- [x] 更新地图组件支持省份信息

---

## 🔍 使用示例

### 示例 1：选择陕西省的西安市

1. 打开资产入库页面
2. 在"所在省份"下拉框中选择"陕西省"
3. "所在城市"下拉框自动更新为陕西省的城市列表
4. 自动选择"西安"（第一个城市）
5. 可以手动更改为其他城市（如"咸阳"、"宝鸡"等）

### 示例 2：选择广东省的深圳市

1. 在"所在省份"下拉框中选择"广东省"
2. "所在城市"下拉框更新为广东省的城市列表
3. 从列表中选择"深圳"
4. 表单数据更新：`province: '广东省'`, `city: '深圳'`

---

## 🎯 优势

1. **数据准确性**：明确的省市分级，避免城市名称重复
2. **用户体验**：直观的两级选择，操作简单
3. **数据完整性**：保存省份信息，便于后续统计和分析
4. **地理编码优化**：结合省份信息，提高地址搜索准确性

---

## 📚 相关文件

- `src/utils/chinaRegions.js`：省市数据定义
- `src/components/ArsenalEntry.jsx`：资产入库表单组件
- `src/components/MapLocationPicker.jsx`：地图位置选择组件
- `server/routes/arsenal.js`：资产提交 API

---

**最后更新**：2025-01-27

