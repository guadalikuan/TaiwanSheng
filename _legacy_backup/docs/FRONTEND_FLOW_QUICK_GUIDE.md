# 前端钱包连接和地堡避险 - 快速操作指南

## 🎯 用户操作流程图

### 完整流程概览

```
┌─────────────────────────────────────────────────────────────┐
│                    用户访问网站首页                            │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
            ┌──────────────────────┐
            │  点击"进入地堡"按钮   │
            └──────────┬───────────┘
                       │
                       ▼
            ┌──────────────────────┐
            │   检查登录状态        │
            └──────────┬───────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
┌───────────────┐           ┌──────────────────┐
│  未登录       │           │  已登录          │
└───────┬───────┘           └────────┬─────────┘
        │                            │
        ▼                            │
┌──────────────────┐                 │
│ 跳转到登录页面   │                 │
└────────┬─────────┘                 │
         │                            │
         ▼                            │
┌──────────────────┐                 │
│ 点击"连接钱包"   │                 │
└────────┬─────────┘                 │
         │                            │
         ▼                            │
┌──────────────────┐                 │
│ Phantom授权连接  │                 │
└────────┬─────────┘                 │
         │                            │
         ▼                            │
┌──────────────────┐                 │
│ 签名登录消息     │                 │
└────────┬─────────┘                 │
         │                            │
         ▼                            │
┌──────────────────┐                 │
│ 后端验证并登录   │                 │
└────────┬─────────┘                 │
         │                            │
         └────────────┬───────────────┘
                      │
                      ▼
            ┌──────────────────────┐
            │   进入地堡页面        │
            └──────────┬───────────┘
                       │
                       ▼
            ┌──────────────────────┐
            │   并行加载数据        │
            │  - 资产列表           │
            │  - 风险数据           │
            │  - 社区统计           │
            │  - 避险能力详情       │
            └──────────┬───────────┘
                       │
                       ▼
            ┌──────────────────────┐
            │   计算并显示生存率   │
            │   初始值：34%         │
            └──────────┬───────────┘
                       │
                       ▼
            ┌──────────────────────┐
            │   用户提升生存率      │
            └──────────┬───────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
┌───────────────┐           ┌──────────────────┐
│ 购买TWS代币   │           │ 购买房产          │
│ +1% per 10K  │           │ +15% base + 位置  │
└───────┬───────┘           └────────┬─────────┘
        │                            │
        └──────────────┬──────────────┘
                       │
                       ▼
            ┌──────────────────────┐
            │   获得组合加成        │
            │   +10% of total       │
            └──────────┬───────────┘
                       │
                       ▼
            ┌──────────────────────┐
            │   生存率实时更新      │
            │   每30秒刷新风险数据  │
            └──────────────────────┘
```

---

## 🔐 钱包连接详细流程

### 步骤 1: 检查钱包安装

**代码**：`src/utils/wallet.js` - `isWalletInstalled()`

```javascript
检查 window.solana && window.solana.isPhantom
```

**用户看到**：
- ✅ 已安装：显示"连接钱包"按钮
- ❌ 未安装：显示"请安装Phantom钱包"提示

### 步骤 2: 连接钱包

**代码**：`src/components/Navbar.jsx` - `handleConnectWallet()`

```javascript
1. 调用 window.solana.connect()
2. 用户点击"连接"授权
3. 获取 Solana 地址
```

**用户操作**：
1. 点击"连接钱包"按钮
2. Phantom 弹出授权窗口
3. 点击"连接"

### 步骤 3: 签名登录消息

**代码**：`src/utils/wallet.js` - `signMessage()`

```javascript
1. 生成登录消息
2. 转换为 Uint8Array
3. 调用 window.solana.signMessage()
4. 转换为 base64 签名
```

**用户操作**：
1. Phantom 弹出签名请求
2. 查看消息内容
3. 点击"签名"

### 步骤 4: 登录/注册

**代码**：`src/contexts/AuthContext.jsx` - `loginWithWalletAuth()`

```javascript
1. 发送登录请求到后端
2. 后端验证签名
3. 返回 JWT token
4. 保存 token 并更新状态
```

**结果**：
- ✅ 已注册：自动登录，刷新页面
- 📝 未注册：跳转到注册页面

---

## 🏰 地堡避险详细流程

### 步骤 1: 进入地堡

**代码**：`src/components/OmegaSection.jsx` - `handleEnterBunker()`

**检查**：
- 未登录 → 跳转到登录页面
- 已登录 → 直接进入地堡

### 步骤 2: 加载数据

**代码**：`src/components/BunkerApp.jsx` - `loadUserData()`

**并行加载**：
```javascript
Promise.all([
  getHomepageAssets(),      // 资产列表
  getRiskData(),            // 风险数据（包含倒计时）
  getBunkerStats(),         // 社区统计
  getRefugeCapacity(address) // 避险能力详情
])
```

**加载的数据**：
- 用户资产列表
- 当前风险等级和分数
- 倒计时信息（ETU）
- 社区统计数据
- 完整的生存率计算详情

### 步骤 3: 计算生存率

**公式**：
```
生存率 = 34% (基础)
       + 代币避险加成 (每10,000 TWS = +1%，最高30%)
       + 房产避险加成 (基础15% + 位置系数×5% + 面积系数×3%)
       + 组合加成 (如果同时持有，总加成×10%)
       - 风险惩罚 (CRITICAL:-20%, HIGH:-10%, MEDIUM:0, LOW:+5%)
```

**计算优先级**：
1. 优先使用后端 API 返回的完整计算结果
2. 如果后端失败，使用前端简化计算

### 步骤 4: 显示地堡界面

**UI 组件**：
- 紧急通知栏（高风险时显示）
- 风险预警卡片
- 生存率大卡片
- TWS 代币卡片
- 房产资产卡片
- 避险能力详情（可展开）
- 社区统计
- 快速行动按钮

### 步骤 5: 实时更新

**更新机制**：
- 每 30 秒自动刷新风险数据
- 风险等级变化时自动调整生存率
- 用户操作后立即刷新相关数据

---

## 💰 提升生存率操作

### 方式 1: 购买 TWS 代币

**操作流程**：
1. 点击"购买代币"按钮
2. 选择购买数量
3. 使用 Solana 钱包支付
4. 购买成功后，生存率立即提升

**加成规则**：
- 每 10,000 TWS = +1% 生存率
- 最高加成：30%（300,000 TWS）

**代码位置**：
- 按钮：`src/components/BunkerApp.jsx` - 快速行动区
- API：`src/utils/api.js` - `createTokenPurchaseOrder()`

### 方式 2: 购买房产

**操作流程**：
1. 点击"购买房产"按钮
2. 浏览资产市场
3. 选择心仪的房产
4. 查看房产避险加成详情
5. 购买房产
6. 购买成功后，生存率立即提升

**加成规则**：
- 基础加成：+15%
- 位置加成：位置系数 × 5%
- 面积加成：面积系数 × 3%

**代码位置**：
- 按钮：`src/components/BunkerApp.jsx` - 快速行动区
- 市场：`src/components/BlackMarket.jsx`

### 方式 3: 组合避险

**自动获得**：
- 如果同时持有代币和房产
- 自动获得组合加成
- 组合加成 = (代币加成 + 房产加成) × 10%

**示例**：
- 代币加成：5%
- 房产加成：20%
- 组合加成：(5% + 20%) × 10% = 2.5%

---

## 📊 数据流图

### 钱包连接数据流

```
用户操作
    ↓
Navbar.handleConnectWallet()
    ↓
wallet.connectWallet()
    ↓
window.solana.connect() → Solana地址
    ↓
wallet.signMessage() → 签名
    ↓
AuthContext.loginWithWalletAuth()
    ↓
API.loginWithWallet() → 后端验证
    ↓
保存 token → 更新状态 → 刷新页面
```

### 地堡避险数据流

```
用户进入地堡
    ↓
BunkerApp.loadUserData()
    ↓
并行请求：
  ├─ getHomepageAssets() → 资产列表
  ├─ getRiskData() → 风险数据
  ├─ getBunkerStats() → 社区统计
  └─ getRefugeCapacity() → 避险能力
    ↓
计算生存率
    ↓
更新 UI 显示
    ↓
定时刷新（每30秒）
```

---

## 🎨 UI 交互说明

### 导航栏钱包连接

**状态**：
- 未连接：蓝色"连接钱包"按钮
- 连接中：显示加载动画
- 已连接：显示用户信息

**位置**：右上角

### 地堡主界面

**布局**：
```
┌─────────────────────────────────────┐
│  紧急通知（高风险时）                │
├─────────────────────────────────────┤
│  风险预警卡片                        │
├─────────────────────────────────────┤
│  生存率：XX%                         │
│  ┌──────────┐  ┌──────────┐         │
│  │ TWS代币  │  │ 房产资产 │         │
│  │ +X%      │  │ +X%      │         │
│  └──────────┘  └──────────┘         │
├─────────────────────────────────────┤
│  避险能力详情（点击展开）            │
├─────────────────────────────────────┤
│  快速行动：                          │
│  [购买代币] [购买房产] [组合避险]    │
└─────────────────────────────────────┘
```

### 交互元素

- **生存率卡片**：点击展开详情
- **代币卡片**：显示余额和加成，点击"购买"跳转
- **房产卡片**：显示资产列表，点击查看详情
- **快速行动按钮**：点击跳转到相应页面

---

## 🔄 实时更新机制

### 定时刷新

**频率**：每 30 秒

**更新内容**：
- 风险等级
- 风险分数
- 倒计时信息
- 生存率（根据风险变化调整）

**代码**：
```javascript
setInterval(() => {
  getRiskData().then(response => {
    // 更新风险数据
    // 重新计算生存率
  });
}, 30000);
```

### 事件驱动更新

**触发时机**：
- 用户购买代币后
- 用户购买房产后
- 用户登录/登出后

**更新方式**：
- 立即刷新相关数据
- 重新计算生存率
- 更新 UI 显示

---

## ✅ 快速检查清单

### 钱包连接
- [ ] Phantom 钱包已安装
- [ ] 连接按钮正常显示
- [ ] 连接流程顺畅
- [ ] 签名功能正常
- [ ] 登录/注册流程完整

### 地堡避险
- [ ] 数据加载正常
- [ ] 生存率计算准确
- [ ] UI 显示正确
- [ ] 实时更新正常
- [ ] 购买功能可用

---

## 📚 相关文档

- **详细流程**：`docs/FRONTEND_WALLET_BUNKER_FLOW.md`
- **避险逻辑**：`docs/BUNKER_REFUGE_LOGIC.md`
- **实现状态**：`docs/BUNKER_IMPLEMENTATION_STATUS.md`

---

**完成！** 🎉

