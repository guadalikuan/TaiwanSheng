//! # 全局配置账户模块
//! 
//! 本模块定义了TOT代币系统的全局配置账户，存储系统的核心状态和配置信息。
//! 这是整个系统的"大脑"，记录了所有关键数据和统计信息。
//! 
//! ============================================
// 文件: programs/tot-token/src/state/config.rs
// 全局配置账户定义
// ============================================

use anchor_lang::prelude::*;
use crate::state::tax::TaxConfig;

/// 全局配置账户
/// 
/// 这是TOT代币系统的核心状态账户，存储了系统的所有全局配置和统计信息。
/// 该账户在系统初始化时创建，是整个系统的"控制中心"。
/// 
/// ## 账户特性
/// 
/// - 使用PDA（程序派生地址）创建，确保地址确定性
/// - 种子: `["tot_config"]`
/// - 只有管理员可以修改
/// - 所有关键操作都需要验证此账户
#[account]
#[derive(Default)]
pub struct TotConfig {
    /// 管理员地址（总司令）
    /// 
    /// 类型: Pubkey (32字节)
    /// 
    /// 说明:
    /// - 拥有系统的最高权限
    /// - 可以执行所有管理员操作（更新税率、冻结账户、暂停系统等）
    /// - 可以转移给其他地址（如多签钱包）
    /// 
    /// 安全建议:
    /// - 建议使用多签钱包作为管理员
    /// - 妥善保管管理员私钥
    /// - 定期审查管理员操作日志
    pub authority: Pubkey,
    
    /// 代币Mint地址
    /// 
    /// 类型: Pubkey (32字节)
    /// 
    /// 说明:
    /// - TOT代币的Mint账户地址
    /// - 用于验证代币类型和获取代币信息
    /// - 在系统初始化时设置，之后不可更改
    /// 
    /// 用途:
    /// - 验证转账的代币类型
    /// - 获取代币总供应量等信息
    /// - 与代币账户进行关联验证
    pub mint: Pubkey,
    
    /// 国库地址
    /// 
    /// 类型: Pubkey (32字节)
    /// 
    /// 说明:
    /// - 用于接收税收和运营资金的账户
    /// - 税收的20%会进入国库
    /// - 可以设置为普通钱包地址或PDA地址
    /// 
    /// 用途:
    /// - 接收运营资金
    /// - 项目开发和维护费用
    /// - 营销和推广费用
    pub treasury: Pubkey,
    
    /// 流动性池地址
    /// 
    /// 类型: Pubkey (32字节)
    /// 
    /// 说明:
    /// - 主流动性池的地址（通常是Raydium池子）
    /// - 用于监控池子深度，计算大额交易惩罚
    /// - 税收的30%会注入此池子
    /// 
    /// 用途:
    /// - 计算价格冲击（用于大额交易惩罚）
    /// - 注入流动性（提升底价）
    /// - 监控市场状态
    pub liquidity_pool: Pubkey,
    
    /// 税率配置账户地址
    /// 
    /// 类型: Pubkey (32字节)
    /// 
    /// 说明:
    /// - 指向TaxConfig账户的地址
    /// - TaxConfig存储了所有动态税率参数
    /// - 可以为None（如果尚未初始化税率配置）
    /// 
    /// 用途:
    /// - 在税率计算时读取配置
    /// - 管理员更新税率参数
    pub tax_config: Pubkey,
    
    /// 恐慌模式标志
    /// 
    /// 类型: bool (1字节)
    /// 
    /// 说明:
    /// - `true`: 系统处于恐慌模式，卖出操作被拒绝
    /// - `false`: 系统正常运行
    /// 
    /// 触发条件:
    /// - 管理员手动启用（应对市场异常）
    /// - 检测到大额抛售（如果实现自动触发）
    /// 
    /// 效果:
    /// - 暂停所有卖出操作
    /// - 买入和普通转账仍可进行（取决于具体实现）
    /// - 用于保护流动性池免受冲击
    pub panic_mode: bool,
    
    /// 系统初始化时间戳
    /// 
    /// 类型: i64 (8字节，Unix时间戳)
    /// 
    /// 说明:
    /// - 记录系统初始化的时间
    /// - 用于计算系统运行时长
    /// - 用于时间相关的验证和计算
    /// 
    /// 用途:
    /// - 审计和统计
    /// - 时间相关的业务逻辑
    pub initialized_at: i64,
    
    /// 总铸造量
    /// 
    /// 类型: u64 (8字节)
    /// 
    /// 说明:
    /// - 累计铸造的代币总数量
    /// - 在`mint_to_pools`执行后设置为TOTAL_SUPPLY
    /// - 用于验证是否已经完成初始铸造
    /// 
    /// 用途:
    /// - 防止重复铸造
    /// - 统计和审计
    pub total_minted: u64,
    
    /// 总销毁量
    /// 
    /// 类型: u64 (8字节)
    /// 
    /// 说明:
    /// - 累计销毁的代币总数量
    /// - 每次税收分配中的销毁部分会累加到此字段
    /// - 用于计算实际流通量
    /// 
    /// 用途:
    /// - 计算实际流通量 = total_minted - total_burned
    /// - 通缩机制统计
    /// - 代币稀缺性分析
    pub total_burned: u64,
    
    /// 累计收税总额
    /// 
    /// 类型: u64 (8字节)
    /// 
    /// 说明:
    /// - 系统累计收取的所有税收总和
    /// - 每次转账的税收都会累加到此字段
    /// - 用于统计和审计
    /// 
    /// 用途:
    /// - 系统收入统计
    /// - 审计和报告
    /// - 分析税收效果
    pub total_tax_collected: u64,
    
    /// 配置版本号
    /// 
    /// 类型: u8 (1字节)
    /// 
    /// 说明:
    /// - 用于标识配置账户的版本
    /// - 初始版本为1
    /// - 未来升级时可以增加版本号
    /// 
    /// 用途:
    /// - 兼容性检查
    /// - 升级管理
    /// - 版本迁移
    pub version: u8,
    
    /// 预留空间
    /// 
    /// 类型: [u8; 128] (128字节)
    /// 
    /// 说明:
    /// - 为未来功能扩展预留的空间
    /// - 可以在不改变账户大小的情况下添加新字段
    /// - 当前未使用，全部为0
    /// 
    /// 用途:
    /// - 未来功能扩展
    /// - 避免账户迁移
    pub _reserved: [u8; 128],
}

impl TotConfig {
    /// 计算账户所需空间
    /// 
    /// 返回配置账户所需的总字节数。
    /// 这个值用于账户初始化时的空间分配。
    /// 
    /// 计算方式:
    /// - 8字节: Anchor自动添加的discriminator
    /// - 各字段的实际大小总和
    /// 
    /// 总大小: 286 字节
    pub const LEN: usize = 8 + // discriminator (Anchor自动添加)
        32 + // authority (Pubkey)
        32 + // mint (Pubkey)
        32 + // treasury (Pubkey)
        32 + // liquidity_pool (Pubkey)
        32 + // tax_config (Pubkey)
        1 + // panic_mode (bool)
        8 + // initialized_at (i64)
        8 + // total_minted (u64)
        8 + // total_burned (u64)
        8 + // total_tax_collected (u64)
        1 + // version (u8)
        128; // reserved ([u8; 128])
}

/// 初始化参数结构体
/// 
/// 用于`initialize`指令的参数传递，允许在初始化时设置可选配置。
/// 所有参数都是可选的，可以在后续通过其他指令设置。
#[derive(AnchorSerialize, AnchorDeserialize, Clone)]
pub struct InitializeParams {
    /// 初始税收配置账户地址
    /// 
    /// 类型: Option<Pubkey>
    /// 
    /// 说明:
    /// - 如果提供，会在初始化时关联税率配置账户
    /// - 如果为None，可以后续通过其他方式设置
    /// - 建议在初始化后立即调用`initialize_tax_config`
    /// 
    /// 默认值: None
    pub tax_config: Option<Pubkey>,
    
    /// 流动性池地址
    /// 
    /// 类型: Option<Pubkey>
    /// 
    /// 说明:
    /// - 如果提供，会在初始化时设置流动性池地址
    /// - 如果为None，可以后续通过其他方式设置
    /// - 通常需要在创建流动性池后才能设置
    /// 
    /// 默认值: None
    pub liquidity_pool: Option<Pubkey>,
}
