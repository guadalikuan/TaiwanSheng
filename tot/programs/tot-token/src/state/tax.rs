//! # 税收配置账户模块
//! 
//! 本模块定义了动态税收配置账户，存储了TOT动态重力场税收模型（TOT-DGTM）的所有参数。
//! 这些参数控制着税率计算的核心逻辑，管理员可以动态调整以适应市场变化。
//! 
//! ## 动态税收模型
//! 
//! TOT采用动态重力场税收模型，税率计算公式为：
//! ```
//! Tax = Base + (P_impact / L) × α + 1/(T_hold + 1)^β × γ
//! ```
//! 
//! 其中：
//! - Base: 基础税率
//! - (P_impact / L) × α: 大额交易惩罚项
//! - 1/(T_hold + 1)^β × γ: 持有时间折扣项
//! 
//! ============================================
// 文件: programs/tot-token/src/state/tax.rs
// 税收配置账户定义
// ============================================

use anchor_lang::prelude::*;

/// 动态税收配置账户
/// 
/// 存储TOT动态重力场税收模型的所有参数和配置。
/// 管理员可以通过更新这些参数来调整税率计算逻辑。
/// 
/// ## 账户特性
/// 
/// - 使用PDA创建，种子: `["tot_tax_config"]`
/// - 只有管理员可以修改
/// - 所有税率计算都基于此配置
#[account]
#[derive(Default)]
pub struct TaxConfig {
    /// 基础税率
    /// 
    /// 类型: u16 (2字节，basis points)
    /// 默认值: 200 (2%)
    /// 取值范围: 0-9900 (0%-99%)
    /// 
    /// 说明:
    /// - 这是所有转账的基础税率，不考虑任何折扣和惩罚
    /// - 用于公式: Tax = Base + 惩罚项 - 折扣项
    /// - 这是给国库的基本供奉，所有转账都需要支付
    /// 
    /// 用途:
    /// - 税率计算公式的基础值
    /// - 确保系统有稳定的收入来源
    pub base_tax_bps: u16,
    
    /// 惩罚系数 α
    /// 
    /// 类型: u64 (8字节，放大100倍存储)
    /// 默认值: 500 (表示5.0)
    /// 
    /// 说明:
    /// - 用于公式中的大额交易惩罚项: (P_impact / L) × α
    /// - α值越大，大额交易的惩罚越重
    /// - 存储时放大100倍，实际值 = alpha / 100
    /// 
    /// 作用:
    /// - 防止大额抛售（砸盘）
    /// - 保护流动性池的稳定性
    /// - 实现"自动熔断式税收"
    /// 
    /// 示例:
    /// - 如果一笔交易占池子深度的10%，惩罚项 = 10% × 5 = 50%
    /// - 这意味着仅惩罚项就会增加50%的税率
    pub alpha: u64,
    
    /// 时间衰减指数 β
    /// 
    /// 类型: u64 (8字节，放大100倍存储)
    /// 默认值: 50 (表示0.5)
    /// 
    /// 说明:
    /// - 用于公式中的持有时间折扣项: 1/(T_hold + 1)^β × γ
    /// - β值控制折扣的衰减速度
    /// - β = 0.5 表示平方根衰减，即折扣随持有时间平方根增长
    /// - 存储时放大100倍，实际值 = beta / 100
    /// 
    /// 作用:
    /// - 奖励长期持有者
    /// - 惩罚短期投机者
    /// - 实现"时间熔炉"机制
    /// 
    /// 效果:
    /// - 持币时间越长，折扣越大
    /// - 但折扣的增长速度会逐渐放缓（平方根特性）
    pub beta: u64,
    
    /// 忠诚度权重 γ
    /// 
    /// 类型: u16 (2字节，basis points)
    /// 默认值: 2000 (20%)
    /// 
    /// 说明:
    /// - 用于公式中的持有时间折扣项: 1/(T_hold + 1)^β × γ
    /// - γ值控制折扣的最大幅度
    /// - 即使持有时间无限长，折扣也不会超过γ值
    /// 
    /// 作用:
    /// - 设置持有时间折扣的上限
    /// - 确保基础税率不会被完全抵消
    /// 
    /// 效果:
    /// - 新用户（< 1天）: 折扣 = 1/1^0.5 × 20% = 20% 额外税
    /// - 长期持有（> 100天）: 折扣 ≈ 1/101^0.5 × 20% ≈ 2% 额外税
    /// - 超长期持有（> 1000天）: 折扣接近0，几乎免税
    pub gamma_bps: u16,
    
    /// 恐慌模式触发阈值
    /// 
    /// 类型: u16 (2字节，basis points)
    /// 默认值: 50 (0.5%)
    /// 
    /// 说明:
    /// - 当单笔卖出交易占池子深度的比例超过此值时，触发恐慌模式
    /// - 恐慌模式下，税率会大幅提高，防止大规模抛售
    /// 
    /// 用途:
    /// - 保护流动性池免受大额抛售冲击
    /// - 实现"反脆弱机制"
    /// 
    /// 触发条件:
    /// - 卖出金额 / 池子深度 > 0.5%
    pub panic_threshold_bps: u16,
    
    /// 恐慌模式税率
    /// 
    /// 类型: u16 (2字节，basis points)
    /// 默认值: 3000 (30%)
    /// 
    /// 说明:
    /// - 当触发恐慌模式时，税率会直接设置为30%
    /// - 这是一个固定的高税率，用于阻止大规模抛售
    /// 
    /// 用途:
    /// - 紧急情况下的保护机制
    /// - 防止市场恐慌导致的流动性枯竭
    pub panic_tax_bps: u16,
    
    /// 动态税启用标志
    /// 
    /// 类型: bool (1字节)
    /// 默认值: true
    /// 
    /// 说明:
    /// - `true`: 启用动态税收计算
    /// - `false`: 禁用动态税，使用固定税率
    /// 
    /// 用途:
    /// - 紧急情况下可以临时禁用动态税
    /// - 系统维护时使用
    pub enabled: bool,
    
    /// 免税地址列表
    /// 
    /// 类型: Vec<Pubkey> (动态数组，最多50个地址)
    /// 最大长度: 50个地址
    /// 
    /// 说明:
    /// - 存储所有免税地址
    /// - 这些地址的转账不收取任何税收
    /// - 通常包括流动性池、DEX合约等系统地址
    /// 
    /// 用途:
    /// - 系统地址免税（避免税收循环）
    /// - 特殊合约地址免税
    /// - 管理员可以动态添加/移除
    #[max_len(50)]
    pub exempt_addresses: Vec<Pubkey>,
    
    /// 最后更新时间戳
    /// 
    /// 类型: i64 (8字节，Unix时间戳)
    /// 
    /// 说明:
    /// - 记录配置最后更新的时间
    /// - 每次参数更新都会更新此字段
    /// 
    /// 用途:
    /// - 审计和追踪
    /// - 版本管理
    pub last_updated: i64,
    
    /// PDA Bump种子
    /// 
    /// 类型: u8 (1字节)
    /// 
    /// 说明:
    /// - 用于PDA派生的bump值
    /// - 确保账户地址的确定性
    /// - 在账户创建时自动计算
    pub bump: u8,
}

impl TaxConfig {
    /// 计算账户所需空间
    /// 
    /// 返回税率配置账户所需的总字节数，用于账户初始化时的空间分配。
    /// 
    /// 总大小: 1655 字节
    /// 
    /// 注意: 由于Vec<Pubkey>需要预留最大空间（50个地址），账户大小较大。
    pub const LEN: usize = 8 + // discriminator (Anchor自动添加)
        2 + // base_tax_bps (u16)
        8 + // alpha (u64)
        8 + // beta (u64)
        2 + // gamma_bps (u16)
        2 + // panic_threshold_bps (u16)
        2 + // panic_tax_bps (u16)
        1 + // enabled (bool)
        4 + // Vec length (u32)
        (32 * 50) + // exempt_addresses (Vec<Pubkey>, max 50 addresses)
        8 + // last_updated (i64)
        1; // bump (u8)
    
    /// 检查地址是否免税
    /// 
    /// 判断指定地址是否在免税列表中。
    /// 
    /// # 参数
    /// * `address` - 要检查的地址（Pubkey引用）
    /// 
    /// # 返回值
    /// * `bool` - `true`表示地址在免税列表中，`false`表示不在
    /// 
    /// # 使用场景
    /// - 在税率计算前检查是否免税
    /// - 如果免税，直接返回0税率
    /// 
    /// # 使用示例
    /// ```rust
    /// if tax_config.is_exempt(&user_address) {
    ///     // 免税，不收取税收
    ///     tax_rate = 0;
    /// } else {
    ///     // 正常计算税率
    ///     tax_rate = calculate_tax(...)?;
    /// }
    /// ```
    pub fn is_exempt(&self, address: &Pubkey) -> bool {
        self.exempt_addresses.contains(address)
    }
    
    /// 添加免税地址
    /// 
    /// 将指定地址添加到免税列表中。只有管理员可以执行此操作。
    /// 
    /// # 参数
    /// * `address` - 要添加的免税地址（Pubkey）
    /// 
    /// # 返回值
    /// * `Result<()>` - 成功返回Ok(())，失败返回相应错误
    /// 
    /// # 验证
    /// 1. 检查地址是否已在列表中（避免重复添加）
    /// 2. 检查列表是否已满（最多50个地址）
    /// 
    /// # 错误
    /// * 如果地址已在列表中，返回`TotError::AddressAlreadyExempt`
    /// * 如果列表已满，返回`TotError::TooManyExemptAddresses`
    /// 
    /// # 使用示例
    /// ```rust
    /// // 添加流动性池地址到免税列表
    /// tax_config.add_exempt(liquidity_pool_address)?;
    /// ```
    pub fn add_exempt(&mut self, address: Pubkey) -> Result<()> {
        // 检查地址是否已在列表中
        require!(
            !self.exempt_addresses.contains(&address),
            crate::errors::TotError::AddressAlreadyExempt
        );
        
        // 检查列表是否已满（最多50个地址）
        require!(
            self.exempt_addresses.len() < 50,
            crate::errors::TotError::TooManyExemptAddresses
        );
        
        // 添加到列表
        self.exempt_addresses.push(address);
        Ok(())
    }
    
    /// 移除免税地址
    /// 
    /// 从免税列表中移除指定地址。只有管理员可以执行此操作。
    /// 
    /// # 参数
    /// * `address` - 要移除的免税地址（Pubkey引用）
    /// 
    /// # 返回值
    /// * `Result<()>` - 成功返回Ok(())，失败返回相应错误
    /// 
    /// # 验证
    /// 1. 检查地址是否在列表中
    /// 2. 从列表中移除该地址
    /// 
    /// # 错误
    /// * 如果地址不在列表中，返回`TotError::AddressNotExempt`
    /// 
    /// # 使用示例
    /// ```rust
    /// // 移除某个地址的免税资格
    /// tax_config.remove_exempt(&target_address)?;
    /// ```
    pub fn remove_exempt(&mut self, address: &Pubkey) -> Result<()> {
        // 查找地址在列表中的位置
        let index = self.exempt_addresses
            .iter()
            .position(|&x| x == *address)
            .ok_or(anchor_lang::error!(crate::errors::TotError::AddressNotExempt))?;
        
        // 从列表中移除
        self.exempt_addresses.remove(index);
        Ok(())
    }
}
